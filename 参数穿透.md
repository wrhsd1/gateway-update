# å‚æ•°ç©¿é€æœºåˆ¶ä¿®å¤æ–‡æ¡£

## é—®é¢˜æè¿°

**æ—¥æœŸ**: 2025-11-02

**é—®é¢˜ç°è±¡**:
éƒ¨åˆ†å‚æ•°åœ¨å‘åç«¯ API è½¬å‘æ—¶è¢«ä¸­è½¬æœåŠ¡èˆå¼ƒï¼Œå¯¼è‡´ä¾›åº”å•†ç‰¹å®šçš„å‚æ•°æ— æ³•æ­£å¸¸ä½¿ç”¨ã€‚

**ç¤ºä¾‹**:
```javascript
// DeepSeek è¯·æ±‚
const body = {
  model: 'DeepSeek-V3.1',
  temperature: 0.6,
  top_p: 0.95,
  max_tokens: 32768,
  enable_thinking: true,  // âŒ è¢«è¿‡æ»¤
  stream: true,
  messages: [...]
}

// Anthropic/å­—èŠ‚è·³åŠ¨ç«å±±å¼•æ“è¯·æ±‚
const body = {
  model: 'ep-844',
  temperature: 0.6,
  top_p: 0.95,
  max_tokens: 32768,
  thinking: { type: 'enabled' },  // âŒ è¢«è¿‡æ»¤
  stream: true,
  messages: [...]
}
```

## æ ¹æœ¬åŸå› 

### 1. ç™½åå•æœºåˆ¶

é¡¹ç›®ä½¿ç”¨äº†**ä¸¥æ ¼çš„ç™½åå•æœºåˆ¶**æ¥å¤„ç†è¯·æ±‚å‚æ•°è½¬å‘ï¼š

**ä½ç½®**: `src/services/transformToProviderRequest.ts`

**åŸå§‹é€»è¾‘**:
```typescript
export const transformUsingProviderConfig = (
  providerConfig: ProviderConfig,
  params: Params,
  providerOptions?: Options
) => {
  const transformedRequest: { [key: string]: any } = {};

  // åªå¤„ç† providerConfig ä¸­å®šä¹‰çš„å‚æ•°
  for (const configParam in providerConfig) {
    if (configParam in params) {
      // è½¬å‘å‚æ•°
    }
  }
  // âŒ æœªåœ¨ providerConfig ä¸­å®šä¹‰çš„å‚æ•°ä¼šè¢«ç›´æ¥ä¸¢å¼ƒ
  return transformedRequest;
};
```

### 2. å‚æ•°é…ç½®ç¤ºä¾‹

æ¯ä¸ªä¾›åº”å•†éƒ½æœ‰è‡ªå·±çš„å‚æ•°é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ DeepSeek:

**ä½ç½®**: `src/providers/deepseek/chatComplete.ts`

```typescript
export const DeepSeekChatCompleteConfig: ProviderConfig = {
  model: { param: 'model', required: true },
  messages: { param: 'messages' },
  max_tokens: { param: 'max_tokens' },
  temperature: { param: 'temperature' },
  // ... åªæœ‰è¿™äº›å®šä¹‰çš„å‚æ•°ä¼šè¢«è½¬å‘
  // enable_thinking æœªå®šä¹‰ï¼Œä¼šè¢«è¿‡æ»¤
};
```

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆå¯¹æ¯”

#### æ–¹æ¡ˆ1ï¼šé€ä¸ªæ·»åŠ å‚æ•°ï¼ˆä¸æ¨èï¼‰
- âŒ éœ€è¦ä¸ºæ¯ä¸ªæ–°å‚æ•°ä¿®æ”¹é…ç½®
- âŒ ç»´æŠ¤æˆæœ¬é«˜
- âŒ æ— æ³•æ”¯æŒæœªçŸ¥çš„æ–°å‚æ•°
- âœ… æ›´ç²¾ç¡®çš„å‚æ•°æ§åˆ¶

#### æ–¹æ¡ˆ2ï¼šå‚æ•°é€ä¼ æœºåˆ¶ï¼ˆå·²é‡‡ç”¨ï¼‰
- âœ… è‡ªåŠ¨æ”¯æŒæ‰€æœ‰å‚æ•°
- âœ… ç»´æŠ¤æˆæœ¬ä½
- âœ… å‘å‰å…¼å®¹æ–°å‚æ•°
- âœ… ä¿ç•™åŸæœ‰éªŒè¯åŠŸèƒ½

### å®ç°æ–¹æ¡ˆ2ï¼šå‚æ•°é€ä¼ 

#### ä¿®æ”¹æ–‡ä»¶1: `src/services/transformToProviderRequest.ts`

**å‡½æ•°**: `transformUsingProviderConfig`

```typescript
export const transformUsingProviderConfig = (
  providerConfig: ProviderConfig,
  params: Params,
  providerOptions?: Options
) => {
  const transformedRequest: { [key: string]: any } = {};
  const processedParams = new Set<string>();

  // ç¬¬ä¸€æ­¥ï¼šå¤„ç†é…ç½®ä¸­å®šä¹‰çš„å‚æ•°
  // åº”ç”¨è½¬æ¢è§„åˆ™ã€éªŒè¯è§„åˆ™ã€é»˜è®¤å€¼ç­‰
  for (const configParam in providerConfig) {
    let paramConfigs = providerConfig[configParam];
    if (!Array.isArray(paramConfigs)) {
      paramConfigs = [paramConfigs];
    }

    for (const paramConfig of paramConfigs) {
      if (configParam in params) {
        const value = getValue(configParam, params, paramConfig);
        setNestedProperty(
          transformedRequest,
          paramConfig?.param as string,
          value
        );
        processedParams.add(configParam);  // è®°å½•å·²å¤„ç†
      }
      else if (
        paramConfig &&
        paramConfig.required &&
        paramConfig.default !== undefined
      ) {
        let value;
        if (typeof paramConfig.default === 'function') {
          value = paramConfig.default(params, providerOptions);
        } else {
          value = paramConfig.default;
        }
        setNestedProperty(transformedRequest, paramConfig.param, value);
        processedParams.add(configParam);
      }
    }
  }

  // ğŸ”¥ ç¬¬äºŒæ­¥ï¼šé€ä¼ æœªå®šä¹‰çš„å‚æ•°
  // å…è®¸è‡ªå®šä¹‰å‚æ•°å’Œæ–°å‚æ•°è‡ªåŠ¨è½¬å‘
  for (const paramKey in params) {
    if (!processedParams.has(paramKey) && params[paramKey] !== undefined) {
      // è·³è¿‡å†…éƒ¨å‚æ•°
      const skipParams = ['config', 'overrideParams'];
      if (!skipParams.includes(paramKey)) {
        transformedRequest[paramKey] = params[paramKey];
      }
    }
  }

  return transformedRequest;
};
```

**å‡½æ•°**: `transformToProviderRequestFormData`

```typescript
const transformToProviderRequestFormData = (
  provider: string,
  params: Params,
  fn: string,
  providerOptions: Options
): FormData => {
  let providerConfig = ProviderConfigs[provider];
  if (providerConfig.getConfig) {
    providerConfig = providerConfig.getConfig({ params, providerOptions })[fn];
  } else {
    providerConfig = providerConfig[fn];
  }
  const formData = new FormData();
  const processedParams = new Set<string>();

  // ç¬¬ä¸€æ­¥ï¼šå¤„ç†é…ç½®ä¸­å®šä¹‰çš„å‚æ•°
  for (const configParam in providerConfig) {
    let paramConfigs = providerConfig[configParam];
    if (!Array.isArray(paramConfigs)) {
      paramConfigs = [paramConfigs];
    }
    for (const paramConfig of paramConfigs) {
      if (configParam in params) {
        const value = getValue(configParam, params, paramConfig);
        formData.append(paramConfig.param, value);
        processedParams.add(configParam);
      } else if (
        paramConfig &&
        paramConfig.required &&
        paramConfig.default !== undefined
      ) {
        let value;
        if (typeof paramConfig.default === 'function') {
          value = paramConfig.default(params);
        } else {
          value = paramConfig.default;
        }
        formData.append(paramConfig.param, value);
        processedParams.add(configParam);
      }
    }
  }

  // ğŸ”¥ ç¬¬äºŒæ­¥ï¼šé€ä¼ æœªå®šä¹‰çš„å‚æ•°
  for (const paramKey in params) {
    if (!processedParams.has(paramKey) && params[paramKey] !== undefined) {
      const skipParams = ['config', 'overrideParams'];
      if (!skipParams.includes(paramKey)) {
        formData.append(paramKey, params[paramKey]);
      }
    }
  }

  return formData;
};
```

## æ ¸å¿ƒæœºåˆ¶

### ä¸¤æ­¥å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·ç«¯è¯·æ±‚å‚æ•° (params)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ä¸€æ­¥ï¼šå¤„ç†å·²å®šä¹‰å‚æ•°                   â”‚
â”‚ â€¢ åº”ç”¨ transform è½¬æ¢                   â”‚
â”‚ â€¢ éªŒè¯ min/max èŒƒå›´                     â”‚
â”‚ â€¢ åº”ç”¨é»˜è®¤å€¼ default                    â”‚
â”‚ â€¢ è®°å½•åˆ° processedParams               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬äºŒæ­¥ï¼šé€ä¼ æœªå®šä¹‰å‚æ•°                   â”‚
â”‚ â€¢ æ£€æŸ¥æ˜¯å¦å·²å¤„ç†                        â”‚
â”‚ â€¢ è·³è¿‡å†…éƒ¨å‚æ•° (config, overrideParams) â”‚
â”‚ â€¢ ç›´æ¥è½¬å‘å…¶ä»–å‚æ•°                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‘é€åˆ°ä¾›åº”å•† API                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è·³è¿‡çš„å†…éƒ¨å‚æ•°

```typescript
const skipParams = ['config', 'overrideParams'];
```

è¿™äº›å‚æ•°æ˜¯ç½‘å…³å†…éƒ¨ä½¿ç”¨çš„ï¼Œä¸åº”è¯¥è½¬å‘ç»™ä¾›åº”å•†ã€‚

## æ•ˆæœéªŒè¯

### æ”¯æŒçš„åœºæ™¯

#### 1. DeepSeek æ€è€ƒæ¨¡å¼

```javascript
const body = {
  model: 'DeepSeek-V3.1',
  temperature: 0.6,
  top_p: 0.95,
  max_tokens: 32768,
  enable_thinking: true,        // âœ… è‡ªåŠ¨è½¬å‘
  thinking_budget: 5000,        // âœ… è‡ªåŠ¨è½¬å‘ï¼ˆå¦‚æœæœ‰ï¼‰
  stream: true,
  messages: [...]
};
```

#### 2. Anthropic/å­—èŠ‚è·³åŠ¨ æ€è€ƒé…ç½®

```javascript
const body = {
  model: 'ep-gn9z',
  temperature: 0.6,
  top_p: 0.95,
  max_tokens: 32768,
  thinking: { type: 'enabled' }, // âœ… è‡ªåŠ¨è½¬å‘
  stream: true,
  messages: [...]
};
```

#### 3. ä»»æ„æ–°å‚æ•°

```javascript
const body = {
  model: 'any-model',
  custom_param: 'value',         // âœ… è‡ªåŠ¨è½¬å‘
  experimental_feature: true,    // âœ… è‡ªåŠ¨è½¬å‘
  new_api_param: { ... },        // âœ… è‡ªåŠ¨è½¬å‘
  messages: [...]
};
```

## ä¼˜åŠ¿

### 1. é€šç”¨æ€§
- âœ… æ”¯æŒæ‰€æœ‰ä¾›åº”å•†çš„æ‰€æœ‰å‚æ•°
- âœ… æ— éœ€ä¸ºæ¯ä¸ªå‚æ•°ç¼–å†™é…ç½®
- âœ… è‡ªåŠ¨é€‚é…æ–°åŠŸèƒ½

### 2. ç»´æŠ¤æ€§
- âœ… ä»£ç æ”¹åŠ¨æœ€å°åŒ–
- âœ… æ— éœ€é¢‘ç¹æ›´æ–°é…ç½®æ–‡ä»¶
- âœ… é™ä½ç»´æŠ¤æˆæœ¬

### 3. å…¼å®¹æ€§
- âœ… å®Œå…¨å‘åå…¼å®¹
- âœ… ä¸å½±å“ç°æœ‰åŠŸèƒ½
- âœ… ä¿ç•™å‚æ•°éªŒè¯æœºåˆ¶

### 4. æ‰©å±•æ€§
- âœ… è‡ªåŠ¨æ”¯æŒæœªæ¥æ–°å¢å‚æ•°
- âœ… æ”¯æŒå®éªŒæ€§åŠŸèƒ½
- âœ… çµæ´»é€‚åº” API å˜åŒ–

## æŠ€æœ¯ç»†èŠ‚

### å‚æ•°å¤„ç†ä¼˜å…ˆçº§

1. **å·²å®šä¹‰å‚æ•°** (é«˜ä¼˜å…ˆçº§)
   - åº”ç”¨è½¬æ¢å‡½æ•° (transform)
   - åº”ç”¨èŒƒå›´éªŒè¯ (min/max)
   - åº”ç”¨é»˜è®¤å€¼ (default)
   - é‡å‘½åå‚æ•° (param)

2. **æœªå®šä¹‰å‚æ•°** (ä½ä¼˜å…ˆçº§)
   - ç›´æ¥é€ä¼ 
   - ä¿æŒåŸå§‹é”®å
   - ä¿æŒåŸå§‹å€¼

### ç¤ºä¾‹ï¼šå‚æ•°è½¬æ¢å¯¹æ¯”

```typescript
// è¾“å…¥
{
  model: 'deepseek-chat',
  max_tokens: 5000,          // å·²å®šä¹‰ï¼Œå¯èƒ½æœ‰ min/max éªŒè¯
  enable_thinking: true,     // æœªå®šä¹‰ï¼Œç›´æ¥é€ä¼ 
  custom_param: 'value'      // æœªå®šä¹‰ï¼Œç›´æ¥é€ä¼ 
}

// è¾“å‡ºï¼ˆå‘é€åˆ°ä¾›åº”å•†ï¼‰
{
  model: 'deepseek-chat',
  max_tokens: 5000,          // âœ… å·²éªŒè¯èŒƒå›´
  enable_thinking: true,     // âœ… åŸæ ·é€ä¼ 
  custom_param: 'value'      // âœ… åŸæ ·é€ä¼ 
}
```

## å·²çŸ¥é…ç½®çš„ä¾›åº”å•†å‚æ•°

### DashScopeï¼ˆé€šä¹‰åƒé—®ï¼‰
å·²åœ¨é…ç½®ä¸­æ”¯æŒæ€è€ƒå‚æ•°ï¼š
```typescript
enable_search: { param: 'enable_search' },
enable_thinking: { param: 'enable_thinking' },
thinking_budget: { param: 'thinking_budget' },
```

### Bedrock/Anthropic
é€šè¿‡ `additionalModelRequestFields` æ”¯æŒï¼š
```typescript
if (params['thinking']) {
  additionalModelRequestFields['thinking'] = params['thinking'];
}
```

### Google Vertex AI
æ”¯æŒæ€è€ƒé…ç½®ï¼š
```typescript
if (params.thinking?.budget_tokens) {
  thinkingConfig['thinking_budget'] = params.thinking.budget_tokens;
}
```

## ç›¸å…³æ–‡ä»¶

- `src/services/transformToProviderRequest.ts` - æ ¸å¿ƒè½¬æ¢é€»è¾‘
- `src/providers/deepseek/chatComplete.ts` - DeepSeek é…ç½®
- `src/providers/dashscope/index.ts` - DashScope é…ç½®
- `src/providers/bedrock/utils.ts` - Bedrock ç‰¹æ®Šå¤„ç†
- `src/types/requestBody.ts` - å‚æ•°ç±»å‹å®šä¹‰

## æ€»ç»“

é€šè¿‡å®ç°å‚æ•°é€ä¼ æœºåˆ¶ï¼Œç³»ç»Ÿç°åœ¨èƒ½å¤Ÿï¼š

1. âœ… **è‡ªåŠ¨è½¬å‘æ‰€æœ‰å‚æ•°**ï¼ŒåŒ…æ‹¬æœªåœ¨é…ç½®ä¸­å®šä¹‰çš„å‚æ•°
2. âœ… **ä¿ç•™éªŒè¯åŠŸèƒ½**ï¼Œå¯¹å·²å®šä¹‰çš„å‚æ•°ä»ç„¶åº”ç”¨è½¬æ¢å’ŒéªŒè¯è§„åˆ™
3. âœ… **å‘å‰å…¼å®¹**ï¼Œè‡ªåŠ¨æ”¯æŒä¾›åº”å•†æ–°å¢çš„ API å‚æ•°
4. âœ… **é™ä½ç»´æŠ¤æˆæœ¬**ï¼Œæ— éœ€ä¸ºæ¯ä¸ªæ–°å‚æ•°æ›´æ–°é…ç½®

è¿™ä¸ªæ”¹è¿›ä½¿å¾—ç½‘å…³æ›´åŠ çµæ´»å’Œé€šç”¨ï¼Œèƒ½å¤Ÿæ›´å¥½åœ°é€‚åº”å„ä¸ªä¾›åº”å•† API çš„å˜åŒ–å’Œæ–°åŠŸèƒ½ã€‚
